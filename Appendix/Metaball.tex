\resetgraphicspath
\appendtographicspath{{./Appendix/figures/Metaball}}


% \chapter{Computation of a metaball}
% \label{sec:erosion-appendix_metaball}

% \shortAbstract{
%     In this section we develop in more detail the formulation used for metaballs used in \cref{chap:erosion} for the simulation of particle erosion on implicit terrains.
% }

% We use the following formula to evaluate a metaball in space with a center $\center$ and of radius $\Radius$:
% $$ g(\p) = 1 - \frac{||\p - \center||}{\Radius} $$
% using the euclidean distance.

% We have a total amount $\totalErosion$ to define in this space, so the final metaball function $f$ needs to satisfy the equations \eqref{eq:erosion-function_f_is_metaball} and \eqref{eq:erosion-int_function_f_is_erosion}:
% \begin{align}
% \label{eq:erosion-function_f_is_metaball}
% f(\p) &= \lambda g(\p) \\
% \label{eq:erosion-int_function_f_is_erosion}
% \int_{\p \in V_{3D}}{f \, dp} &= \totalErosion
% \end{align}

% First, let's exploit the radial symmetry of the metaball and rewrite $g(\p) = 1 - r$ by using the spherical coordinates of the point $\p - \center$.

% We can then integrate $g$ over the volume $V_{3D}$ as 
% \begin{align}
% &\int_{0}^{1}{ \int_{0}^{\pi}{ \int_{0}^{2\pi}{ g(r) r^2 \sin(\angl)\, dr} \, d\angl} \, d\anglTwo} \nonumber \\
% = &\int_{0}^{1}{ \int_{0}^{\pi}{ \int_{0}^{2\pi}{ (1 - r) r^2 \sin(\angl)\, dr} \, d\angl} \, d\anglTwo} \nonumber \\
% &= \int_{0}^{1}{ (1 - r)r^2 \, dr} \times \int_{0}^{\pi}{ \sin{\angl} \, d\angl } \times \int_{0}^{2\pi}{ 1 \, d\anglTwo} \nonumber
% \end{align}

% We then break down the integrals one by one such that 
% $$ \int_{0}^{1}{ (1 - r)r^2 \, dr} = \frac{1}{12} \nonumber$$ 
% $$ \int_{0}^{\pi}{ \sin{\angl} \, d\angl } = 2 \nonumber$$ 
% $$ \int_{0}^{2\pi}{ 1 \, d\anglTwo} = 2 \pi \nonumber$$

% By combining all these integrals, we get $\int{g} = \frac{1}{12} \times 2 \times 2\pi = \frac{\pi}{3}$.

% So given $\int{f} = \erosionAmount$ and $\int{f} = \lambda \int{g}$, we can deduce that $\lambda = \frac{\totalErosion}{\int{g}} = \frac{3}{\pi}\totalErosion$.

% From \eqref{eq:erosion-function_f_is_metaball} we finally get 
% \begin{align} 
% \label{eq:erosion-proofErosionMetaball}
% f(\p) = \frac{3 \totalErosion}{\pi} \left(1 - \frac{||\p - \center||}{\Radius} \right)
% \end{align}
% , representing the rate of change on the evaluation function of the terrain surface.

% The integration in the voxel space is out of the scope of this paper and a numerical solution is instead proposed in \cref{sec:erosion-application_on_voxels}.


\chapter{Computation of a metaball}
\label{sec:erosion-appendix_metaball}

\shortAbstract{
    In this section we develop in more detail the formulation used for metaballs in \cref{chap:erosion} for the simulation of particle erosion on implicit terrains.
}

\section{Linear metaball derivation}

We use the following formula to evaluate a metaball in space with a center $\center$ and radius $\Radius$:
\begin{equation}
    g(\p) = \max\!\left(1 - \frac{\abs{\p - \center}}{\Radius},\,0\right),
\end{equation}
where the Euclidean distance is used, and $g$ is clamped to zero outside the sphere of radius $\Radius$.

We have a total amount $\totalErosion$ to define in this space, so the final metaball function $f$ must satisfy
\begin{align}
    \label{eq:erosion-function_f_is_metaball}
    f(\p) &= \lambda\, g(\p), \\
    \label{eq:erosion-int_function_f_is_erosion}
    \int_{\p \in B_{\Radius}(\center)} f(\p) \, d\p &= \totalErosion,
\end{align}
where $B_{\Radius}(\center)$ denotes the ball of radius $\Radius$ centered at $\center$.

Exploiting radial symmetry, we set $r = \abs{\p - \center} / \Radius \in [0,1]$ and write $g(\p) = 1 - r$.  
In spherical coordinates of the normalised point $(\p - \center)/\Radius$, the volume element is $\Radius^3\, r^2 \sin(\angl)\, dr\, d\angl\, d\anglTwo$.  
The integral of $g$ over $B_{\Radius}(\center)$ becomes
\begin{align}
    &\Radius^3 \int_{0}^{1} \int_{0}^{\pi} \int_{0}^{2\pi} (1 - r) \, r^2 \, \sin(\angl)\, dr\, d\angl\, d\anglTwo \nonumber \\
    &= \Radius^3 \left[ \int_{0}^{1} (1 - r) r^2 \, dr \right]
       \left[ \int_{0}^{\pi} \sin{\angl} \, d\angl \right]
       \left[ \int_{0}^{2\pi} 1 \, d\anglTwo \right] \nonumber \\
    &= \Radius^3 \times \frac{1}{12} \times 2 \times 2\pi \nonumber \\
    &= \frac{\pi}{3} \, \Radius^3.
\end{align}

Given $\int f = \totalErosion$ from \cref{eq:erosion-int_function_f_is_erosion} and $\int f = \lambda \int g$, we obtain
\begin{equation}
    \lambda = \frac{\totalErosion}{\int g} = \frac{3}{\pi\,\Radius^3}\,\totalErosion.
\end{equation}

From \eqref{eq:erosion-function_f_is_metaball}, the normalised linear metaball is
\begin{equation} 
    \label{eq:erosion-proofErosionMetaball}
    f(\p) = \frac{3 \,\totalErosion}{\pi\,\Radius^3} \;
    \max\!\left(1 - \frac{\abs{\p - \center}}{\Radius},\,0\right),
\end{equation}
representing the rate of change applied to the terrain's evaluation function.

\subsection*{Derivatives}
Let $\rho = \abs{\p - \center}$, $r=\rho/\Radius$, and $\vec{u} = (\p - \center)/\rho$ (the unit radial vector).  
For $0 < r < 1$,
\begin{equation}
    \nabla f(\p) = -\frac{\lambda}{\Radius} \, \vec{u},
    \qquad
    \Delta f(\p) = -\frac{2\lambda}{\Radius^2\, r}.
\end{equation}
We define by convention $\nabla f(\center) = 0$.  
The function $f$ is only $C^0$: the derivative $\phi'(r)$ of its radial profile is discontinuous at $r=0$ and $r=1$, and the Laplacian diverges as $r \to 0$.

The integration in voxel space is out of the scope of this appendix; a numerical solution is instead proposed in \cref{sec:erosion-application_on_voxels}.


\section{Other possible radial falloff functions}
\label{sec:erosion-appendix-other-falloffs}

The linear falloff in \cref{eq:erosion-proofErosionMetaball} is only one possible choice of radial profile. We write
\begin{equation}
    x = \frac{\abs{\p - \center}}{\Radius}, \qquad
    g(\p) = \phi(x),
\end{equation}
where $\phi: [0,\infty) \to \mathbb{R}_{\ge 0}$ is compactly supported, i.e. $\phi(x) = 0$ for $x \ge 1$. If a smoother boundary is desired, pick $\phi$ such that $\phi(1) = 0$ and $\phi'(1) = 0$ (or higher-order vanishing derivatives).

We want to decompose the final function as $f(\p) = \lambda\,\phi(x)$ with $\lambda$ a scaling factor. Using spherical coordinates and radial symmetry,
\begin{equation}
    \int_{\p\in\mathbb{R}^3} g(\p)\,d\p
    = 4\pi\,\Radius^3 \underbrace{\int_{0}^{1} \phi(x)\,x^2\,dq}_{J_\phi},
\end{equation}
so that, given the total amount $\totalErosion$, the normalisation reads
\begin{align}
    \label{eq:metaball-general-J}
    \lambda = \frac{\totalErosion}{4\pi\,\Radius^3\,J_\phi},
    \qquad
    f(\p) = \lambda\,\phi\!\left(\frac{\abs{\p - \center}}{\Radius}\right).
\end{align}

For implementation, it is convenient to record the radial derivatives once. Let $\rho=\abs{\p - \center}$, $x=\rho/\Radius$, and $\vec{u}=(\p-\center)/\rho$ (defined for $\rho>0$). For $0<x<1$,
\begin{equation}
    \nabla f(\p) = \frac{\lambda}{\Radius}\,\phi'(x)\,\vec{u},
    \qquad
    \Delta f(\p) = \frac{\lambda}{\Radius^2}\!\left[\phi''(x) + \frac{2}{x}\,\phi'(x)\right].
\end{equation}
By convention, we set $\nabla f(\center)=0$. The smoothness at $x=0$ and $x=1$ depends on $\phi$; if $\phi'(0)\neq 0$ or $\phi'(1)\neq 0$, the gradient is discontinuous at the corresponding point.

\newcommand{\kernelcard}[8]{%
\begin{minipage}[t]{0.45\linewidth}
    \vspace{0pt}
    \textbf{#1} (\cref{fig:metaball-alternatives-#2})\\[0.25em]
    \setlength{\abovedisplayskip}{4pt}\setlength{\belowdisplayskip}{4pt}
    \begin{align*}
        \phi(x)   &\,=\, #3\\
        \phi'(x)  &\,=\, #4\\
        \phi''(x) &\,=\, #5\\[0.25em]
        J_\phi    &\,=\, #6\\
        \lambda   &\,=\, #7
    \end{align*}
    \small \emph{#8}
\end{minipage}\hfill
\begin{minipage}[t]{0.5\linewidth}
    \begin{figure}[H]
      \centering
    \vspace{0pt}
    \autofitgraphics{%
      metaball_#2_Q-0-1_R-0-75.png,%
      depos_#2_Q-0-1_R-0-75.png}
    \autofitgraphics{
      erosion_#2_Q-0-5_R-0-75.png,%
      slope_#2.png%
    }
    \caption{Top left: #1 profile. Top right: deposition on a plane $f_\text{plane}(x, y)=-y$ with $\totalErosion=0.1$ and $\Radius=0.75$. Bottom left: erosion with $\totalErosion=-0.5$ and $\Radius=0.75$. Bottom right: multiple eroding metaballs on an inclined plane. }
    \label{fig:metaball-alternatives-#2}
    % \caption{#1 profile. Visuals are 2D slices through $\center$; image parameters use $Q\equiv\totalErosion$ and $R\equiv\Radius$.}
  \end{figure}
  \end{minipage}
}


\kernelcard{Linear}{linear}
{ \max(1-x,0) }
{ -1 }
{ 0 }
{ \tfrac{1}{12} }
{ \dfrac{3\,\totalErosion}{\pi\,\Radius^3} }
{Continuity: $C^0$; gradient discontinuous at $x=0$ and $x=1$. A standard piecewise-linear choice.}

\kernelcard{Smoothstep}{smoothstep}
{ \max\left(1-3x^2+2x^3, 0\right) }
{ -6x+6x^2 }
{ -6+12x }
{ \tfrac{1}{15} }
{ \dfrac{15\,\totalErosion}{4\pi\,\Radius^3} }
{Continuity: $C^1$ with $\phi'(0)=\phi'(1)=0$; widely used in graphics as the cubic smoothstep \cite{Perlin2002}.}

\kernelcard{Smootherstep}{smootherstep}
{ \max\left(1-10x^3+15x^4-6x^5, 0\right) }
{ -30x^2+60x^3-30x^4 }
{ -60x+180x^2-120x^3 }
{ \tfrac{5}{84} }
{ \dfrac{21\,\totalErosion}{5\pi\,\Radius^3} }
{Continuity: $C^2$ with $\phi'(0)=\phi'(1)=0$; quintic smootherstep popularized by Perlin for higher-order smoothness \cite{Perlin2002}.}

\kernelcard{Wendland}{wendland}
{ \max\left((1-x)^4(1+4x), 0\right) }
{ -20x(1-x)^3 }
{ -20(1-x)^2(1-4x) }
{ \tfrac{1}{42} }
{ \dfrac{21\,\totalErosion}{2\pi\,\Radius^3} }
{Continuity: $C^2$ in 3D; a compactly supported, positive definite RBF of minimal degree \cite{Wendland1995}.}

\kernelcard{Biweight kernel}{biweight}
{ \max\left((1-x^2)^2, 0\right) }
{ -4x(1-x^2) }
{ -4+12x^2 }
{ \tfrac{8}{105} }
{ \dfrac{105\,\totalErosion}{32\pi\,\Radius^3} }
{Continuity: $C^1$ at $x=1$ (and $\phi'(0)=0$). A quartic kernel from density estimation \cite{Silverman1998, Wand1993}).}

\kernelcard{Triweight kernel}{triweight}
{ \max\left((1-x^2)^3, 0\right) }
{ -6x(1-x^2)^2 }
{ -6(1-x^2)(1-5x^2) }
{ \tfrac{16}{315} }
{ \dfrac{315\,\totalErosion}{64\pi\,\Radius^3} }
{Continuity: $C^2$ at $x=1$ (and $\phi'(0)=0$). A sextic kernel in the KDE literature \cite{Silverman1998,Wand1993}.}

\kernelcard{Raised cosine}{cosine}
{ \max\left(\tfrac{1+\cos(\pi x)}{2}, 0\right) }
{ -\tfrac{\pi}{2}\sin(\pi x) }
{ -\tfrac{\pi^2}{2}\cos(\pi x) }
{ \tfrac{1}{6}-\tfrac{1}{\pi^2} }
{ \dfrac{3\pi\,\totalErosion}{(2\pi^2-12)\,\Radius^3} }
{Continuity: $C^\infty$ on $(0,1)$ with $\phi'(0)=\phi'(1)=0$; a standard compactly supported kernel in statistics \cite{Soh2013}.}

Any other compactly supported $\phi$ can be used: we just need to compute $J_\phi$ once (analytically or numerically) and plug it into \eqref{eq:metaball-general-J}.


% \pagebreak\pagebreak













% We use the following formula to evaluate a metaball in space with a center $\center$ and of radius $\Radius$:
% $$ g(\p) = \max\!\left(1 - \frac{\abs{\p - \center}}{\Radius},\,0\right) $$
% using the Euclidean distance, and clamped to zero outside the sphere of radius $\Radius$.

% We have a total amount $\totalErosion$ to define in this space, so the final metaball function $f$ needs to satisfy the equations \eqref{eq:erosion-function_f_is_metaball} and \eqref{eq:erosion-int_function_f_is_erosion}:
% \begin{align}
%     \label{eq:erosion-function_f_is_metaball}
%     f(\p) &= \lambda g(\p) \\
%     \label{eq:erosion-int_function_f_is_erosion}
%     \int_{\p \in V_{3D}} f(\p) \, d\p &= \totalErosion
% \end{align}
% where $V_{3D}$ is the ball of radius $\Radius$ centered at $\center$.

% First, let's exploit the radial symmetry of the metaball and rewrite $g(\p) = 1 - r$ by using the spherical coordinates of the normalised point $(\p - \center)/\Radius$, where $r \in [0,1]$.

% The volume element in these coordinates is $\Radius^3\, r^2 \sin(\angl)\, dr\, d\angl\, d\anglTwo$, so we can integrate $g$ over the volume $V_{3D}$ as 
% \begin{align}
%     &\Radius^3 \int_{0}^{1} \int_{0}^{\pi} \int_{0}^{2\pi} g(r)\, r^2 \sin(\angl)\, dr\, d\angl\, d\anglTwo \nonumber \\
%     =&\Radius^3 \int_{0}^{1} \int_{0}^{\pi} \int_{0}^{2\pi} (1 - r) r^2 \sin(\angl)\, dr\, d\angl\, d\anglTwo \nonumber \\
%     =&\Radius^3 \left[ \int_{0}^{1} (1 - r) r^2 \, dr \right]
%     \times \left[ \int_{0}^{\pi} \sin{\angl} \, d\angl \right]
%     \times \left[ \int_{0}^{2\pi} 1 \, d\anglTwo \right] \nonumber
% \end{align}

% We then break down the integrals one by one such that 
% \begin{align}
%     \int_{0}^{1}{ (1 - r)r^2 \, dr} = \frac{1}{12} \nonumber 
%     \int_{0}^{\pi}{ \sin{\angl} \, d\angl } = 2 \nonumber 
%     \int_{0}^{2\pi}{ 1 \, d\anglTwo} = 2 \pi \nonumber
% \end{align}

% By combining all these integrals, we get 
% \begin{align}
%     \int g = \Radius^3 \times \frac{1}{12} \times 2 \times 2\pi = \frac{\pi}{3} \Radius^3.
% \end{align}

% So given $\int f = \totalErosion$ and $\int f = \lambda \int g$, we can deduce that 
% \begin{align}
%     \lambda = \frac{\totalErosion}{\int g} = \frac{3}{\pi\,\Radius^3}\,\totalErosion.
% \end{align}

% From \eqref{eq:erosion-function_f_is_metaball} we finally get 
% \begin{align} 
%     \label{eq:erosion-proofErosionMetaball}
%     f(\p) = \frac{3 \,\totalErosion}{\pi\,\Radius^3} \;
%     \max\!\left(1 - \frac{\abs{\p - \center}}{\Radius},\,0\right)
% \end{align}
% representing the rate of change on the evaluation function of the terrain surface.

% The integration in the voxel space is out of the scope of this paper and a numerical solution is instead proposed in \cref{sec:erosion-application_on_voxels}.


% \section*{Other possible radial falloff functions}

% The linear falloff used above, $g(\p)=\max\!\left(1-\frac{\abs{\p - \center}}{\Radius},0\right)$ is only one choice, we thought to be the simplest. More generally, let
% \begin{align}
%     x=\frac{\abs{\p - \center}}{\Radius},\qquad
%     g(\p)=\phi(x),
% \end{align}

% with a compactly supported radial profile $\phi:[0,\infty)\to\mathbb{R}_{\ge 0}$ such that $\phi(x)=0$ for $x\ge 1$ (clamped outside the sphere). If a smoother boundary is desired, pick $\phi$ with $\phi(1)=0$ and $\phi'(1)=0$ (or higher-order vanishing derivatives). The normalisation follows the same pattern as before:
% \begin{align}
%     \label{eq:metaball-general-J}
%     \int_{\p\in\mathbb{R}^3} g(\p)\,d\p = 4\pi\,\Radius^3 \underbrace{\int_{0}^{1}\phi(x)\,x^2\,dq}_{J_\phi}
%     \qquad
%     \lambda=\frac{\totalErosion}{4\pi\,\Radius^3\,J_\phi}
%     \qquad
%     f(\p)=\lambda\,\phi\!\left(\frac{\abs{\p - \center}}{\Radius}\right)
% \end{align}

% Below are convenient choices with closed-form $J_\phi=\int_0^1\phi(x)x^2\,dq$ and the resulting $\lambda$.

% \subsection*{Linear }
% \begin{align}
%     \phi(x)=\max(1-x,0), 
%     \quad J_\phi=\tfrac{1}{12},
%     \quad \lambda=\frac{3\,\totalErosion}{\pi\,\Radius^3}
% \end{align}


% \begin{figure}[H]
%     \autofitgraphics{metaball_linear_Q-0-1_R-0-75.png, depos_linear_Q-0-1_R-0-75.png, erosion_linear_Q-0-5_R-0-75.png, slope_linear.png, slope_linear_neg.png}
% \end{figure}

% \subsection*{Smoothstep }
% \begin{align}
%     \phi(x)=
%     \begin{cases}
%         1-3q^2+2q^3,& 0\le x\le 1 \\
%         0,& x>1
%     \end{cases},
%     \quad J_\phi=\tfrac{1}{15},
%     \quad \lambda=\frac{15\,\totalErosion}{4\pi\,\Radius^3}
% \end{align}

% \begin{figure}[H]
%     \autofitgraphics{metaball_smoothstep_Q-0-1_R-0-75.png, depos_smoothstep_Q-0-1_R-0-75.png, erosion_smoothstep_Q-0-5_R-0-75.png, slope_smoothstep.png, slope_smoothstep_neg.png}
% \end{figure}

% \subsection*{Smootherstep }
% \begin{align}
%     \phi(x)=
%     \begin{cases}
%         1-10q^3+15q^4-6q^5,& 0\le x\le 1 \\
%         0,& x>1
%     \end{cases},
%     \quad J_\phi=\tfrac{5}{84},
%     \quad \lambda=\frac{21\,\totalErosion}{5\pi\,\Radius^3}
% \end{align}


% \begin{figure}[H]
%     \autofitgraphics{metaball_smootherstep_Q-0-1_R-0-75.png, depos_smootherstep_Q-0-1_R-0-75.png, erosion_smootherstep_Q-0-5_R-0-75.png, slope_smootherstep.png, slope_smootherstep_neg.png}
% \end{figure}

% \subsection*{Wendland }
% \begin{align}
%     \phi(x)=
%     \begin{cases}
%         (1-x)^4(1+4q),& 0\le x\le 1,\\
%         0,& x>1,
%     \end{cases},
%     \quad J_\phi=\tfrac{1}{42},
%     \quad \lambda=\frac{21\,\totalErosion}{2\pi\,\Radius^3}
% \end{align}


% \begin{figure}[H]
%     \autofitgraphics{metaball_wendland_Q-0-1_R-0-75.png, depos_wendland_Q-0-1_R-0-75.png, erosion_wendland_Q-0-5_R-0-75.png, slope_wendland.png, slope_wendland_neg.png}
% \end{figure}

% \subsection*{Biweight kernel }
% \begin{align}
%     \phi(x)=
%     \begin{cases}
%         (1-x^2)^2,& 0\le x\le 1,\\
%         0,& x>1,
%     \end{cases},
%     \quad J_\phi=\tfrac{8}{105},
%     \quad \lambda=\frac{105\,\totalErosion}{32\pi\,\Radius^3}
% \end{align}


% \begin{figure}[H]
%     \autofitgraphics{metaball_biweight_Q-0-1_R-0-75.png, depos_biweight_Q-0-1_R-0-75.png, erosion_biweight_Q-0-5_R-0-75.png, slope_biweight.png, slope_biweight_neg.png}
% \end{figure}

% \subsection*{Triweight kernel }
% \begin{align}
%     \phi(x)=
%     \begin{cases}
%         (1-x^2)^3,& 0\le x\le 1,\\
%         0,& x>1,
%     \end{cases},
%     \quad J_\phi=\tfrac{16}{315},
%     \quad \lambda=\frac{315\,\totalErosion}{64\pi\,\Radius^3}
% \end{align}


% \begin{figure}[H]
%     \autofitgraphics{metaball_triweight_Q-0-1_R-0-75.png, depos_triweight_Q-0-1_R-0-75.png, erosion_triweight_Q-0-5_R-0-75.png, slope_triweight.png, slope_triweight_neg.png}
% \end{figure}

% \subsection*{Raised cosine }
% \begin{align}
%     \phi(x)=
%     \begin{cases}
%         \tfrac{1+\cos(\pi x)}{2},& 0\le x\le 1,\\
%         0,& x>1,
%     \end{cases},
%     \quad J_\phi=\tfrac{1}{6}-\tfrac{1}{\pi^2},
%     \quad \lambda=\frac{3\pi\,\totalErosion}{(2\pi^2-12)\,\Radius^3}
% \end{align}


% \begin{figure}[H]
%     \autofitgraphics{metaball_cosine_Q-0-1_R-0-75.png, depos_cosine_Q-0-1_R-0-75.png, erosion_cosine_Q-0-5_R-0-75.png, slope_cosine.png, slope_cosine_neg.png}
% \end{figure}

% Any other compactly supported $\phi$ can be used: we just need to compute $J_\phi$ once (analytically or numerically) and plug it into \eqref{eq:metaball-general-J}.