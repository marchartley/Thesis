\resetgraphicspath
\appendtographicspath{{"Appendix/figures/Ellipsoid/"}}


\chapter{Computation of ellipsoids in 2.5D}
\label{app:ellipsoid-matrix}

\shortAbstract{
    We construct a closed-form height query $z=f(x,y)$ for a rotated ellipsoid, to be used as a deposition/erosion primitive on height fields. The derivation stays in matrix form, gives the operator's projected footprint, aligns the ellipsoid to the terrain normal, clips it in the local frame to keep a consistent cap, and ends with simple update rules and partial derivatives.
}

We start from a representation that already contains the ellipsoid's orientation, so that subsequent steps only query a single object. Let $\vec r=[x,y,z]^\top \in\mathbb{R}^3$ be global coordinates. In the local (unrotated) frame, an ellipsoid with semi-axes $a,b,c>0$ satisfies
\begin{align}
    \label{eq:app-canonical-ellipsoid}
    \vec r'^\top  A \vec r' = 1, \\
    A=\operatorname{diag}\!\left(1/a^2, 1/b^2, 1/c^2\right),
\end{align}

with local coordinates $\vec r'=[x',y',z']^\top $. If $R\in \mathrm{SO}(3)$ maps global to local coordinates, i.e.\ $\vec r'=R^\top \vec r$, then substituting into \cref{eq:app-canonical-ellipsoid} and setting $Q=RAR^\top $ gives a single symmetric matrix that describes the rotated ellipsoid in global coordinates:
\begin{align}
    \label{eq:app-global-implicit}
    \vec r^\top  Q \vec r = 1 \\
    Q =
    \begin{bmatrix}
        Q_{11} & Q_{12} & Q_{13}\\
        Q_{12} & Q_{22} & Q_{23}\\
        Q_{13} & Q_{23} & Q_{33}
    \end{bmatrix}.
\end{align}

Expanding the scalar form,
\begin{align}
    \label{eq:app-expanded}
    Q_{11}x^2 + Q_{22}y^2 + Q_{33}z^2 + 2Q_{12}xy + 2Q_{13}xz + 2Q_{23}yz = 1.
\end{align}

A height field asks for $z$ at a given $(x,y)$. We therefore isolate $z$ in \cref{eq:app-expanded} and obtain a quadratic equation:
\begin{align}
    \label{eq:app-quadratic-coeffs}
    A' z^2 + B' z + C' = 0,
    \qquad
    A' = Q_{33},\quad
    B' = 2(Q_{13}x + Q_{23}y),\quad
    C' = Q_{11}x^2 + 2Q_{12}xy + Q_{22}y^2 - 1.
\end{align}

Writing $\Delta(x,y)=B'^2-4A'C'$ for the discriminant, the surface exists where $\Delta\ge 0$ and the two shells are
\begin{align}
    \label{eq:app-upper}
    \text{upper:}\quad z = f(x,y) = \frac{-B' + \sqrt{ \Delta }}{ 2A' }, \\
    \label{eq:app-lower}
    \text{lower:}\quad z = \frac{-B' - \sqrt{\Delta}}{2A'}.
\end{align}

Substituting the coefficients yields a compact expression that depends only on the six independent entries of $Q$:
\begin{align}
    \label{eq:app-upper-final}
    f(x,y) = \frac{-(Q_{13}x+Q_{23}y) + \sqrt{(Q_{13}x+Q_{23}y)^2 - Q_{33} \left(Q_{11}x^2 + 2Q_{12}xy + Q_{22}y^2 - 1\right)} }{Q_{33}}.
    % \qquad \Delta\ge 0.
\end{align}

% \footnote{Near the silhouette, evaluate the upper root as $z=\tfrac{2C'}{-B'-\mathrm{sign}(B')\sqrt{\Delta}}$ to avoid cancellation, and clamp $\Delta\leftarrow \max(\Delta,0)$ in floating point.}

It is convenient to make the planar domain explicit. Eliminating $z$ from \cref{eq:app-global-implicit} gives the projected footprint via a Schur complement:
\begin{align}
    M =
    \begin{bmatrix}
    Q_{11} & Q_{12}\\
    Q_{12} & Q_{22}
    \end{bmatrix}
    -
    \frac{1}{Q_{33}}
    \begin{bmatrix}
    Q_{13}\\ Q_{23}
    \end{bmatrix}
    \begin{bmatrix}
    Q_{13} & Q_{23}
    \end{bmatrix},
    \qquad
    \text{so that}\quad
    \begin{bmatrix}x & y\end{bmatrix} M \begin{bmatrix}x\\ y\end{bmatrix} \le 1.
\end{align}
This ellipse in $(x,y)$ is exactly equivalent to $\Delta(x,y)\ge 0$ and provides a cheap mask in implementations.

For terrain applications, the ellipsoid should "follow" the local slope. We orient it by the terrain normal at a query point $(x_0,y_0)$, with
\begin{align}
    \label{eq:app-terrain-normal}
    \vec n=\operatorname{normalise} [-\partial_x H, -\partial_y H, 1]^\top.
\end{align}

We build the local frame as:
\begin{align}
    \vec e_z'=\vec n,
    \qquad
    \vec e_x'=\operatorname{normalise} [1,0,-\partial_x H]^\top ,
    \qquad
    \vec e_y'=\vec e_z'\times \vec e_x',
\end{align}

and set
\begin{align}
    \label{eq:app-rotation-from-normal}
    R=[ \vec e_x'\ \ \vec e_y'\ \ \vec e_z' ],
\end{align}

which feeds back into \cref{eq:app-global-implicit} and therefore into \cref{eq:app-quadratic-coeffs}-\cref{eq:app-upper-final}. This alignment changes both the footprint and the height response in a way that is consistent with the local terrain.

A rotated upper shell can lie above the ground on one side and below on the other; height fields cannot represent overhangs. To keep a single, consistent cap, we clip in the local frame by the plane $z'=0$. Writing $\vec r_0=[x_0,y_0,H(x_0,y_0)]^\top $, the plane in global coordinates is $\vec n^\top (\vec r-\vec r_0)=0$, since $\vec n$ is the third column of $R$. Admissible points then satisfy
\begin{align}
    \vec r^\top Q\vec r \le 1,
    \qquad
    \left(R^\top (\vec r-\vec r_0)\right)_3 \ge 0,
\end{align}

which enforces compatibility with a single-valued height field. With $z'=0$ through the local center, the retained volume is exactly one half of the ellipsoid, $V_{\text{clip}}=\tfrac{2}{3}\pi abc$.

Turning the cap into an update of the terrain is then a direct comparison between the cap height and the current surface. Let $f_{+}(x,y)$ denote the clipped upper shell height and set $H_0=H(x_0,y_0)$. We use
\begin{align}
    \text{deposition:} \quad H_{\text{new}}(x,y)=\max\left(H(x,y), f_{+}(x,y)+H_0\right), \\
    \text{erosion:}\quad H_{\text{new}}(x,y)=\min\left(H(x,y), f_{+}(x,y)+H_0\right),
\end{align}
which preserves the single-valued surface and avoids undercuts.

For shading and transport we also need slopes of the cap. Writing $\Phi(x,y,z)=A'z^2+B'z+C'=0$ with the coefficients in \cref{eq:app-quadratic-coeffs}, implicit differentiation of the surface gives
\begin{align}
    f_x=-\frac{\partial_x\Phi}{\partial_z\Phi},
    \qquad
    f_y=-\frac{\partial_y\Phi}{\partial_z\Phi} \\
    \partial_z\Phi=2A' f + B' = 2\left(Q_{33} f + Q_{13}x + Q_{23}y\right),
\end{align}
and
\begin{align}
    \partial_x B'=2Q_{13},\quad
    \partial_x C'=2Q_{11}x+2Q_{12}y,
    \qquad
    \partial_y B'=2Q_{23},\quad
    \partial_y C'=2Q_{12}x+2Q_{22}y,
\end{align}

so that

\begin{align}
    \label{eq:app-fx}
    f_x = -\frac{Q_{13}f + Q_{11}x + Q_{12}y}{Q_{33}f + Q_{13}x + Q_{23}y}, \\
    \label{eq:app-fy}
    f_y = -\frac{Q_{23}f + Q_{12}x + Q_{22}y}{Q_{33}f + Q_{13}x + Q_{23}y}.
\end{align}

In practice, for a fixed ellipsoid $(a,b,c)$ at $(x_0,y_0)$, one computes $R$ from the terrain normal by \cref{eq:app-terrain-normal}-\cref{eq:app-rotation-from-normal}, forms $Q=RAR^\top $ and the footprint matrix $M$, and then, for each $(x,y)$ in a stencil around $(x_0,y_0)$, skips points with $[x\ \ y] M [x\ \ y]^\top >1$, evaluates $f$ by \cref{eq:app-quadratic-coeffs}-\cref{eq:app-upper-final} (upper root), and applies the deposition/erosion rule above. Caching the six independent entries of $Q$ (and $M$) makes the loop entirely local and $O(1)$ per sample. 
\footnote{When evaluating \cref{eq:app-upper-final} near the silhouette we can use the more stable form
$z=\frac{2C'}{-b - \operatorname{sign}(b)\sqrt{\Delta}}$
for the upper root instead of the classic 
$z=\frac{-b + \sqrt{\Delta}}{2a}$ 
to avoid floating-point precision error when $b^2 \gg 4ac$.}



\section*{normalisation to a specific volume change}

We often want the primitive to produce a prescribed volume change $\totalErosion>0$ (amount of material added/removed). Because the ellipsoid is built in its local principal frame and then rotated, we rely on the fact that rotation does not change volumes. Let the semi-axes be $(a,b,c)$ in the local frame, the clipping plane be $z'=z_0$ with $z_0\in[0,c]$ (default $z_0=0$), and denote by
\[
V(z_0)=\iint \left(z_{\text{ellip}}(x,y)-z_{\text{plane}}(x,y)\right)_+\,dx\,dy
\]
the cap volume above the plane, where $(\cdot)_+=\max(\cdot,0)$ and the integral is over the planar footprint. In the local frame one has the closed form
\begin{align}
    \label{eq:app-cap-volume}
    V(z_0)=\pi a b\left(\frac{2c}{3}-z_0+\frac{z_0^3}{3c^2}\right),\qquad V(0)=\frac{2}{3}\pi a b c.
\end{align}
This expression is strictly decreasing in $z_0\in[0,c)$ since $V'(z_0)=-\pi a b\left(1-(z_0/c)^2\right)<0$.

For implementation on a height field, it is convenient to separate the cap into a \emph{plane} and a \emph{thickness}. With $\vec r_0=[x_0,y_0,H(x_0,y_0)]^\top$, terrain normal $\vec n=[n_x,n_y,n_z]^\top$ as in \cref{eq:app-terrain-normal}, and the local offset $z_0\ge 0$, the clipping plane in global coordinates is
\begin{align}
    \label{eq:app-cap-plane}
    \vec n^\top(\vec r-\vec r_0)=z_0,
    \ \Longleftrightarrow\
    z_{\text{plane}}(x,y)=H_0+\frac{z_0-n_x(x-x_0)-n_y(y-y_0)}{n_z},\quad H_0=H(x_0,y_0).
\end{align}
Let $z_{\text{ellip}}(x,y)$ denote the upper shell from \cref{eq:app-upper-final} (evaluated with the centered coordinates used in the chapter). The (nonnegative) cap thickness is
\begin{align}
    \label{eq:app-cap-thickness}
    g_{z_0}(x,y)=\left(z_{\text{ellip}}(x,y)-z_{\text{plane}}(x,y)\right)_+.
\end{align}
The three strategies below differ only in how they achieve $\iint g\,dx\,dy=\totalErosion$ (\cref{fig:ellipsoid-strategies}).

\begin{figure}
    \autofitgraphics[]{ellipsoid_strategies-s.pdf}
    \setfitratios{1, 1, 1}
    \autofitcaptions[]{Strategy A: top-view scaling, Strategy B: axis-scaled, Strategy C: plane-cutting}
    \caption{Three strategies are proposed to fit an oriented ellipsoid to a specific volume which are (A) scale the projection on the Z-axis, (B) scale the ellipsoid parameter $c$, or (C) displace the cutting plane. The initial oriented ellipsoid (dotted black) is transformed following strategies A, B or C (arrows), which result in its top-view projection (red). }
    \label{fig:ellipsoid-strategies}
\end{figure}

\subsection*{Strategy A: top-view amplitude scaling}
Keep $(a,b,c)$ and the plane $z'=z_0$ fixed and scale the thickness by a single factor $\lambda$:
\begin{align}
    \label{eq:app-stratA}
    \lambda=\frac{\totalErosion}{V(z_0)},\qquad
    f_A(x,y)=z_{\text{plane}}(x,y)+\lambda\,g_{z_0}(x,y).
\end{align}
With the default half-ellipsoid ($z_0=0$),
\begin{align}
    \lambda=\frac{3\,\totalErosion}{2\pi a b c}.
\end{align}
This preserves the footprint and simply scales peak height and slopes.

\subsection*{Strategy B: axis-scaled}
Change the vertical semi-axis to $c'$ so that the geometric half-cap volume equals $\totalErosion$, and do not apply an amplitude scale:
\begin{align}
    \label{eq:app-stratB}
    c'=\frac{3\,\totalErosion}{2\pi a b},\qquad
    A=\operatorname{diag}\!\left(1/a^2,\,1/b^2,\,1/{c'}^{2}\right),\quad Q=RAR^\top,
\end{align}
then recompute \cref{eq:app-upper-final} to \cref{eq:app-fy} and use
\begin{align}
    f_B(x,y)=z_{\text{plane}}(x,y)+g_{0}(x,y)\quad\text{with $c$ replaced by $c'$ and $z_0=0$}.
\end{align}
This exactly normalises the half-volume. Note that changing $c$ modifies $Q$ and therefore the projected footprint $M$ via the Schur complement.

\subsection*{Strategy C: plane-cutting}
Keep $(a,b,c)$ fixed and choose the clipping offset $z_0$ so that the cap volume equals $\totalErosion$:
\begin{align}
    \label{eq:app-stratC}
    \text{find }z_0\in[0,c]\ \text{such that}\ V(z_0)=\totalErosion,\qquad f_C(x,y)=z_{\text{plane}}(x,y)+g_{z_0}(x,y).
\end{align}
Since $V$ in \cref{eq:app-cap-volume} is monotone, $z_0$ is unique. A robust choice is bisection on $[0,c]$; Newton is also effective with
\begin{align}
    z_0^{(k+1)}=z_0^{(k)}-\frac{V(z_0^{(k)})-\totalErosion}{V'(z_0^{(k)})},\qquad
    V'(z_0)=-\pi a b\left(1-\frac{z_0^2}{c^2}\right).
\end{align}
This strategy keeps local curvature (via $(a,b,c)$) but reduces support by lifting the plane.

% \subsection*{Applying the strategies}
% In the deposition/erosion rules, replace $f_{+}(x,y)$ by $f_A$, $f_B$, or $f_C$ from \cref{eq:app-stratA,eq:app-stratB,eq:app-stratC}. Use $\totalErosion$ as a magnitude; the sign is handled by the $\max/\min$ update:
% \begin{align}
% \text{deposition: } H_{\text{new}}(x,y)=\max\!\left(H(x,y),\,f_\star(x,y)\right),\qquad
% \text{erosion: } H_{\text{new}}(x,y)=\min\!\left(H(x,y),\,f_\star(x,y)\right),
% \end{align}
% with $f_\star\in\{f_A,f_B,f_C\}$. Strategy~C requires $\totalErosion\le V(0)$ if we restrict to $z_0\in[0,c]$; otherwise use Strategy~A or~B (or allow $z_0<0$ to include more than half the ellipsoid).

% \begin{figure}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-2-0_R-0-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-2-0_R-20-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-2-0_R-45-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-2-0_R-70-0.pdf}
%     \label{fig:ellipsoid-compare-methods-Q-2-0}
%     \caption{Ellipsoid bump with approximated volume $\totalErosion=2.0$, with from left to right strategies A (top-view amplitude scaling), B (axis-scaled) and C (plane cutting), varying the surface angle (from top to bottom: 0°, 20°, 45°, 70°). }
% \end{figure}
% \begin{figure}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-1-0_R-0-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-1-0_R-20-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-1-0_R-45-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-1-0_R-70-0.pdf}
%     \label{fig:ellipsoid-compare-methods-Q-1-0}
%     \caption{Ellipsoid bump with approximated volume $\totalErosion=1.0$, with from left to right strategies A (top-view amplitude scaling), B (axis-scaled) and C (plane cutting), varying the surface angle (from top to bottom: 0°, 20°, 45°, 70°). }
% \end{figure}
% \begin{figure}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-5_R-0-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-5_R-20-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-5_R-45-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-5_R-70-0.pdf}
%     \label{fig:ellipsoid-compare-methods-Q-0-5}
%     \caption{Ellipsoid bump with approximated volume $\totalErosion=0.5$, with from left to right strategies A (top-view amplitude scaling), B (axis-scaled) and C (plane cutting), varying the surface angle (from top to bottom: 0°, 20°, 45°, 70°). }
% \end{figure}
% \begin{figure}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-1_R-0-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-1_R-20-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-1_R-45-0.pdf}
%     \autofitgraphics[trim={0 1.5cm 0 3.2cm},clip]{ellipsoid-compare-methods_Q-0-1_R-70-0.pdf}
%     \label{fig:ellipsoid-compare-methods-Q-0-1}
%     \caption{Ellipsoid bump with approximated volume $\totalErosion=0.1$, with from left to right strategies A (top-view amplitude scaling), B (axis-scaled) and C (plane cutting), varying the surface angle (from top to bottom: 0°, 20°, 45°, 70°). }
% \end{figure}

% \subsection*{Notes on stability}
% Clamp the discriminant $\Delta\leftarrow\max(\Delta,0)$ when evaluating \cref{eq:app-upper-final}, and near the silhouette use the more stable form
% \[
% z=\frac{2C'}{-B'-\operatorname{sign}(B')\sqrt{\Delta}}
% \]
% for the upper root to avoid cancellation. Ensure $n_z>0$ in \cref{eq:app-cap-plane} (the height-field assumption); if $n_z$ becomes too small, cap the slope or resample the operator at a coarser scale.














% \zzcommand{\ct}{\cos \angl}
% \zzcommand{\cct}{\cos^2 \angl}
% \zzcommand{\st}{\sin \angl}
% \zzcommand{\sst}{\sin^2 \angl}

% \zzcommand{\cp}{\cos \anglTwo}
% \zzcommand{\ccp}{\cos^2 \anglTwo}
% \zzcommand{\sp}{\sin \anglTwo}
% \zzcommand{\ssp}{\sin^2 \anglTwo}


% \chapter{Computation of ellipsoids in 2.5D}
% \label{chap:computation-ellipsoid}

% \shortAbstract{
%     In the erosion process on a height field, we may want to represent the impact of a particle collision on a surface as a half sphere that we flatten to increase or lower the surface of the ground. The scaling should happen in the direction of the ground normal. In three dimensions, we may use the implicit formulation of an ellipsoid to achieve this, but in 2.5D this computation become trickier. We will first introduce the conversion to transform the 2D ellipse surface into a 1D function, then proceed with the 3D surface of an ellipsoid into a 2D function, such that it may be then used in the case of 2.5D terrain functions.
% }

% \section{Simplified to ellipses}

% We will first illustrate the computation in a reduced dimension. In this case, we look at an ellipse.
% The common equation for an ellipse is function of $x$, $y$, the half-length $a$ and half-width $b$:
% \begin{align}
%     \label{eq:ellipsoid_simplified-ellipse}
%     \frac{x^2}{a^2} + \frac{y^2}{b^2} = 1
% \end{align}

% We can generalize the equation to translate the center of the ellipse to the position $(x_0, y_0)$ by setting $x'=(x-x_0)$ and $y'=(y-y_0)$ and apply a rotation $\angl$:
% \begin{align}
%     \label{eq:ellipsoid_general-ellipse}
%     \frac{(x' \ct + y' \st)^2}{a^2} + \frac{(x' \st - y' \ct)^2}{b^2} = 1
% \end{align}

% For the rest of the operations, we will consider $x_0=0$ and $y_0=0$ for concisness.
% However this function takes $x$ and $y$ as parameters while we would like to remove $y$ from the equation to lower the 2D shape in a 1D function $f(x)$.

% Isolating the variable $y$ transforms the formulation into a quadratic equation:
% \begin{align}
%     \label{eq:ellipsoid_full-ellipse}
%     y^2 \left( \frac{\sst}{a^2} + \frac{\cct}{b^2} \right) + 2yx \ct \st \left( \frac{1}{a^2} - \frac{1}{b^2} \right) + x^2 \left( \frac{\cct}{a^2} + \frac{\sst}{b^2} \right) - 1 = 0
% \end{align}

% We want to solve the quadratic equation using the form 
% \begin{align}
%     Ay^2 + By + C = 0
% \end{align}

% Decomposing the equation \eqref{eq:ellipsoid_full-ellipse}, we find
% \begin{align}
%     A &= \frac{\sst}{a^2} + \frac{\cct}{b^2} \\
%     B &= 2x \ct \st \left( \frac{1}{a^2} - \frac{1}{b^2} \right) \\
%     C &= x^2 \left( \frac{\cct}{a^2} + \frac{\sst}{b^2} \right) - 1
% \end{align}


% Solving $f(x)$ gets us to 
% \begin{align}
%     \label{eq:ellipsoid_final-ellipse}
%     f(x) = \frac{-B + \sqrt{B^2 - 4 A C}}{2 A}
% \end{align}

% The function $f(x)$ provides us with the "upper shell" of the ellipse at the position $x$.

% Since the function is directly related to the domain of the ellipse, we can compute the bounds of the function by identifying the two points where the tangent is vertical. From the general ellipse formulation (\eqref{eq:ellipsoid_general-ellipse}), we get 
% \begin{align}
%     \label{eq:ellipsoid_ellipse-bounds}
%     x_{\text{min}} &= -\sqrt{a^2 \cct + b^2 \sst} \\
%     x_{\text{max}} &= +\sqrt{a^2 \cct + b^2 \sst} \\
%     y_{\text{max}} &= \sqrt{a^2 \sst + b^2 \cct} \\
%     y_{\text{min}} &= \min\left( f(x_{\text{min}}), f(x_{\text{max}}) \right)
% \end{align}

% The area under the curve is half the area of an ellipse, such that 
% \begin{align}
%     \int_{x_{\text{min}}}^{x_{\text{max}}} f(x)  dx = \frac{\pi a b}{2}
% \end{align}

% Finally, we consider the ground locally linear with a rotation $\angl$ such that the ground surface is defined as $g(x) = x \tan(\angl)$. So the amount of material that is being added as such can be computed as:
% \begin{align}
%     \text{Area} = \int \max \left( f(x) - g(x), 0 \right)   dx
% \end{align}
% We correct the added area by scaling the added matter:
% \begin{align}
%     \Tilde{g}(x) = g(x) + \frac{\max \left( f(x) - g(x), 0 \right)}{\text{Area}} \pi a b
% \end{align}










% \section{Complex case for ellipsoids}
% We will use a similar method to translate this idea from the ellipse to the ellipsoid.

% First, the common equation of an ellipsoid is defined as $x$, $y$, $z$, and $a$, $b$, $c$ respectively the half-length, half-width and half-depth of the ellipsoid:
% \begin{align}
%     \label{eq:ellipsoid_simplified-ellipsoid}
%     \frac{x^2}{a^2} + \frac{y^2}{b^2} + \frac{z^2}{c^2} = 1
% \end{align}

% We can generalize the equation to translate the center of the ellipse to the position $(x_0, y_0, z_0)$ by setting $x'=(x-x_0)$, $y'=(y-y_0)$ and $z'=(z-z_0)$ and apply a rotation $(\angl, \anglTwo)$. Once again, we will consider $x_0=0$, $y_0=0$ and $z_0=0$, but including them becomes trivial:
% \begin{align}
%     \label{eq:ellipsoid_general-ellipsoid}
%       &\frac{\left( x \cp\ct + y \sp - z \cp\st \right)^2}{a^2} \\
%     + &\frac{\left( -x\sp\ct + y\cp + z\sp\st \right)^2}{b^2} \\
%     + &\frac{\left( x\st + z\ct \right)^2}{c^2} - 1 = 0
% \end{align}

% We would like to remove $z$ from the equation to lower the 3D shape in a 2D function $f(x,y)$.

% Isolating the variable $z$ transforms the formulation into a quadratic equation that we will directly decompose in the form $Az^2 + Bz + C = 0$:
% \begin{align}
%     A &= \left( \frac{\ccp\sst}{a^2} + \frac{\ssp\sst}{b^2} + \frac{\cct}{c^2} \right) \\
%     B &= -2x\left( \frac{\ccp\ct\st}{a^2} + \frac{\ssp\cct\st}{b^2} - \frac{\st\ct}{c^2} \right) \\ &+ 2y \left( -\frac{\sp\cp\st}{a^2} + \frac{\cp\st\sp}{b^2} \right) \\
%     C &= x^2 \left( \frac{\ccp\cct}{a^2} + \frac{\ssp\cct}{b^2} + \frac{\sst}{c^2} \right) + y^2 \left( \frac{\ssp}{a^2} + \frac{\ccp}{b^2} \right)
% \end{align}

% Solving $f(x, y)$ gets us, once again, to 
% \begin{align}
%     \label{eq:ellipsoid_final-ellipsoid}
%     f(x) = \frac{-B + \sqrt{B^2 - 4 A C}}{2 A}
% \end{align}

% The function $f(x, y)$ provides us with the "upper shell" of the ellipsoid at the position $(x, y)$.

% While the function heavily relies on the trigonometric functions $\cos$ and $\sin$, we need to keep in mind that $\angl$ and $\anglTwo$ are set for the ellipsoid, meaning that we can compute the value of $\cp, \ccp, \sp, \ssp, \ct, \cct, \st$ and $\sst$ once and use them for any point $(x, y)$.

% % For finding the domain of definition of the function $f$, we solve the inequality $B^2 - 4 A C \geq 0$.
% % \begin{align}
% %     \label{eq:ellipsoid_ellipsoid-bounds}
% %     \left( -c^2 y (a^2 - b^2) \frac{\sin(2\anglTwo)}{2} + x \left( -a^2 b^2 + a^2 c^2 \sin^2(\anglTwo) + b^2 c^2 \cos^2(\anglTwo) \right) \cos(\angl) \right)^2 \sin^2(\angl) - \left( -a^2 b^2 c^2 + c^2 y \left( -x (a^2 - b^2) \left( \sin(2\anglTwo - \angl) + \sin(2\anglTwo + \angl) \right)/2 + y \left( a^2 \cos^2(\anglTwo) + b^2 \sin^2(\anglTwo) \right) \right) + x^2 \left( a^2 b^2 \sin^2(\angl) + a^2 c^2 \sin^2(\anglTwo) \cos^2(\angl) + b^2 c^2 \cos^2(\anglTwo) \cos^2(\angl) \right) \right)
% % \end{align}

% The volume under the function is half the volume of an ellipsoid, such that 
% \begin{align}
%     \int_{x_{\text{min}}}^{x_{\text{max}}} \int_{y_{\text{min}}}^{y_{\text{max}}} f(x, y)  dx  dy = \frac{2 \pi a b c}{3}
% \end{align}

% [TO BE CONTINUED...?]

% % Finally, we consider the ground locally linear with a rotation $\angl$ such that the ground surface is defined as $g(x) = x \tan(\angl)$. So the amount of material that is being added as such can be computed as:
% % \begin{align}
% %     \text{Area} = \int \max \left( f(x) - g(x), 0 \right)   dx
% % \end{align}
% % We correct the added area by scaling the added matter:
% % \begin{align}
% %     \Tilde{g}(x) = g(x) + \frac{\max \left( f(x) - g(x), 0 \right)}{\text{Area}} \pi a b
% % \end{align}




% \chapter{Matrix formulation of a rotated ellipsoid's upper shell}
% \label{app:ellipsoid-matrix}

% \shortAbstract{ 
%     In this appendix we derive, in a concise matrix form, the height-field representation $z = f(x,y)$ of an arbitrarily oriented ellipsoid.  The result is a closed-form formula for the upper (and lower) shell that is readily evaluated in $O(1)$ for any query point $(x,y)$, making it well suited to deposition/erosion on 2.5-D height fields.
% }

% %-----------------------------------------------------------------
% \section{Implicit equation in global coordinates}
% Let the global position be the column vector $ \vec{r} = [ x,\;y,\;z ]^\top \in\mathbb R^{3}$. An ellipsoid of semi-axes $a,b,c>0$, expressed in its local (unrotated) frame, satisfies the implicit equation

% \begin{align}
%     \label{eq:app-canonical-ellipsoid}
%     \vec{r'}^\top  A \vec{r'} = 1
%     \quad\text{with}\quad 
%     A = \operatorname{diag}\!\left(1/a^{2}, 1/b^{2}, 1/c^{2}\right),
% \end{align}
% where $\vec{r'} = [x',y',z']^\top $ are local coordinates.

% Let $R$ be the rotation matrix that takes global coordinates into the ellipsoid frame; hence

% \begin{align}
%     \label{eq:app-rprime}
%     \vec{r'} \;=\; R^\top   \vec{r}.
% \end{align}
% Substituting~\ref{eq:app-rprime} into \ref{eq:app-canonical-ellipsoid} and defining $Q \;=\; R A R^\top $, we obtain the ellipsoid in global coordinates:

% \begin{align}
%     \label{eq:app-global-implicit}
%      \vec{r}^\top  Q  \vec{r} \;=\; 1.
% \end{align}
% Because $A$ is diagonal and $R$ orthogonal, $Q$ is symmetric ($Q^\top =Q$).  Write

% \begin{align}
%     Q \;=\;
%     \begin{bmatrix}
%     Q_{11} & Q_{12} & Q_{13}\\
%     Q_{12} & Q_{22} & Q_{23}\\
%     Q_{13} & Q_{23} & Q_{33}
%     \end{bmatrix}.
% \end{align}

% Expanding \cref{eq:app-global-implicit} gives the familiar quadratic form

% \begin{align}
%     \label{eq:app-expanded}
%     Q_{11}x^{2} + Q_{22}y^{2} + Q_{33}z^{2}
%     + 2Q_{12}xy + 2Q_{13}xz + 2Q_{23}yz \;=\; 1.
% \end{align}

% %-----------------------------------------------------------------
% \section{Solving for the height field $z=f(x,y)$}
% For a height-field terrain we treat $x$ and $y$ as known query coordinates and solve~\eqref{eq:app-expanded} for $z$. Collecting terms yields a quadratic in $z$:

% \begin{align}
%     A' z^{2} + B' z + C' \;=\; 0,
%     \quad\text{with}\quad
%     \begin{cases}
%         A' &= Q_{33},\\
%         B' &= 2\left(Q_{13}x + Q_{23}y\right),\\
%         C' &= Q_{11}x^{2} + 2Q_{12}xy + Q_{22}y^{2} - 1.
%     \end{cases}
%     \label{eq:app-quadratic-coeffs}
% \end{align}
% The discriminant

% \begin{align}
%     \Delta(x,y) \;=\; B'^{2} - 4A'C'
% \end{align}
% is non-negative exactly inside the projected ellipse; outside, the surface is not defined.  Assuming $A'>0$ (always true for proper ellipsoids),

% \begin{align}
%     \text{upper shell:}\quad
%     z &= f(x,y)
%     \;=\;
%     \frac{-B' + \sqrt{\Delta}}{2A'},
%     \label{eq:app-upper}\\begin{align}4pt]
%     \text{lower shell:}\quad
%     z &= \frac{-B' - \sqrt{\Delta}}{2A'}.
%     \label{eq:app-lower}
% \end{align}

% \cref{eq:app-upper} is the function you can add to (or subtract from) a height map to model deposition or erosion produced by an ellipsoidal particle impact.

% %-----------------------------------------------------------------
% \section{Practical notes}

% \begin{itemize}
% \item \textbf{Pre-computation.} For a fixed ellipsoid, compute $Q$ once and cache the six independent coefficients $Q_{11},Q_{22},Q_{33},Q_{12},Q_{13},Q_{23}$. Each height query then requires only a handful of multiplies, an addition, and a square root.

% \item \textbf{Domain mask.} Evaluate $\Delta(x,y)$; if $\Delta<0$ the point lies outside the projected ellipse and $f(x,y)$ should be treated as undefined (or simply return the original terrain height).

% \item \textbf{Volume check.} Integrating~\eqref{eq:app-upper} over the projected ellipse yields $V = \tfrac23\pi abc$, i.e.\ half the ellipsoid volume, confirming consistency with the canonical formulation.

% \end{itemize}


% %-----------------------------------------------------------------
% \section{Alignment with the local terrain}
% \label{app:ellipsoid-alignment}

% For each impact position $(x_0,y_0)$ the terrain offers only a scalar height $H(x_0,y_0)$, but its first-order tangent plane is fully determined by the lateral derivatives

% \begin{align}
%     \partial_x H \;=\;
%     \frac{H(x_0+\delta,y_0)-H(x_0-\delta,y_0)}{2\delta},
%     \qquad
%     \partial_y H \;=\;
%     \frac{H(x_0,y_0+\delta)-H(x_0,y_0-\delta)}{2\delta}.
% \end{align}

% A convenient unit normal of that plane is

% \begin{align}
%     \label{eq:app-terrain-normal}
%     \vec n \;=\; 
%     \operatorname{normalise}
%     \left[ -\partial_x H,\; -\partial_y H,\; 1 \right]^\top .
% \end{align}

% We choose the ellipsoid's local $z'$-axis to coincide with $\vec n$ so that the body "hugs" the terrain.  An orthonormal basis $\{ \vec e_x',\vec e_y',\vec e_z' \}$ is built as:

% \begin{align}
%     \vec e_z' = \vec n,
%     \quad
%     \vec e_x' = 
%     \operatorname{normalise}\!\left[ 1,0,-\partial_x H \right]^\top ,
%     \quad
%     \vec e_y' = \vec e_z' \times \vec e_x'.
% \end{align}

% Finally the rotation matrix that maps global coordinates into the ellipsoid frame is

% \begin{align}
%     \label{eq:app-rotation-from-normal} R \;=\;
%     \left[ 
%     \vec e_x' \;\; \vec e_y' \;\; \vec e_z'
%     \right].
% \end{align}

% Note that $R$ varies per impact point and must be recomputed whenever the ellipsoid moves across the height field.

% %-----------------------------------------------------------------
% \section{Local cutting plane}
% \label{app:ellipsoid-cutting-plane}
% To ensure the ellipsoid interacts only with the half-space above the approximate terrain, we clip by the plane

% \begin{align}
%     z' = z_0, 
%     \quad\text{with}\; z_0 = 0.
% \end{align}

% In global space that plane is

% \begin{align}
%     \vec n^\top ( \vec{r}- \vec{r}_0)=0,
%     \quad
%      \vec{r}_0 = 
%     \begin{bmatrix} 
%         x_0 \\ 
%         y_0 \\ 
%         H(x_0,y_0)
%     \end{bmatrix},
% \end{align}

% because $\vec n$ is the third column of $R$.  Thus an admissible point on the ellipsoid satisfies both

% \begin{align}
%      \vec{r}^\top Q \vec{r} \le 1,
%     \qquad z' = \left(R^\top  \vec{r}\right)_3 \;\ge\; 0.
% \end{align}

% The volume that survives the clip is exactly one half of the original ellipsoid, $V_\text{clip} = \frac{2}{3} \pi abc$, matching a physical "contact cap".  Using $z_0=0$ keeps the formulas simple and still lets you realise thicker/thinner caps by scaling the axis $c$.

% %-----------------------------------------------------------------
% \section{Updating the height field}
% \label{app:ellipsoid-height-update}

% Denote the pre-impact terrain by $H(x,y)$ and the clipped ellipsoid height by $f_{\smash{+}}(x,y)$ given by \cref{eq:app-upper} to \cref{eq:app-terrain-normal}.  We distinguish two operations:

% \subsection*{Deposition.} 
% Material is added wherever the ellipsoid cap sits above the terrain:

% \begin{align} 
%     H_{\text{new}}(x,y) \;=\;
%     \max\left( H(x,y),\; f_{+}(x,y)+H(x_0,y_0) \right).
% \end{align}

% \subsection*{Erosion.} 
% Material is removed wherever the terrain rises into the cap's volume:

% \begin{align} 
%     H_{\text{new}}(x,y) \;=\;
%     \min\left( H(x,y),\; f_{+}(x,y)+H(x_0,y_0) \right).
% \end{align}

% These max/min updates preserve the single-valued nature of the height field, avoid undercuts, and guarantee that the modified surface never falls below (deposition) nor rises above (erosion) the contact cap defined by the clipped ellipsoid. A full implementation simply queries $f_{+}(x,y)$ on a stencil around
% $(x_0,y_0)$ and applies the above formula, giving physically plausible addition or removal of material with $O(N)$ complexity for an $N$-cell stencil.

% %=================================================================





% %-----------------------------------------------------------------
% \subsection*{Closed-form height of the upper shell}

% With the abbreviations of \cref{eq:app-quadratic-coeffs}, insert $A'=Q_{33}$, $B'=2(Q_{13}x+Q_{23}y)$ and $C'=Q_{11}x^{2}+2Q_{12}xy+Q_{22}y^{2}-1$ directly into \cref{eq:app-upper}.  Dividing numerator and denominator by 2 yields a compact expression that involves only the six independent entries of $Q$:

% \begin{align}
%     \label{eq:app-upper-final}
%     f(x,y)\;=\;
%     \frac{
%     -\left(Q_{13}x+Q_{23}y\right)
%     +\sqrt{
%         \left(Q_{13}x+Q_{23}y\right)^{2}
%         -Q_{33}\left(Q_{11}x^{2}+2Q_{12}xy+Q_{22}y^{2}-1\right)
%     }
%     }{Q_{33}},
%     \qquad
%     \Delta(x,y)\ge 0.
% \end{align}

% \cref{eq:app-upper-final} is the final, rotation-agnostic formula for the height of the upper ellipsoid shell measured above the $(x,y)$-plane.

% %-----------------------------------------------------------------
% \subsection*{Partial derivatives}

% The surface is implicitly defined by $\Phi(x,y,z)=A'z^{2}+B'z+C'=0$ with $A',B',C'$ as above. Implicit differentiation gives, for any coordinate~$u$,

% \begin{align}
%     \Phi_x + \Phi_z f_x = 0
%     \quad\Longrightarrow\quad
%     f_x = -\frac{\partial_x\Phi}{\partial_z\Phi},
% \end{align}

% and analogously for $f_y$. Because $A'$ is constant in $(x,y)$,

% \begin{align}
% \partial_z\Phi \;=\; 2A'f + B' 
%                  \;=\; 2\left(Q_{33}f + Q_{13}x+Q_{23}y\right).
% \end{align}

% The required horizontal derivatives are

% \begin{align}
%     \partial_x B' &= 2Q_{13}, &\qquad \\
%     \partial_x C' &= 2Q_{11}x + 2Q_{12}y,\\
%     \partial_y B' &= 2Q_{23}, &\qquad \\
%     \partial_y C' &= 2Q_{12}x + 2Q_{22}y.
% \end{align}

% Hence

% \begin{align}
%     \label{eq:app-fx}
%     f_x &= -\frac{Q_{13}f + Q_{11}x + Q_{12}y}{Q_{33}f + Q_{13}x + Q_{23}y}, \\
%     \label{eq:app-fy}
%     f_y &= -\frac{Q_{23}f + Q_{12}x + Q_{22}y}{Q_{33}f + Q_{13}x + Q_{23}y}.
% \end{align}

% The gradient $(f_x,f_y,-1)$ (or its normalised version) supplies the local normal, slopes, or analytic curvature, which is useful, for example, in terrain  shading, adaptive meshing, or erosion flux models.